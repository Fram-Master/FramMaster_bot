name: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£

on:
  push:
    branches: [ main ]
    paths:
      - 'changelog/README.md'
      - 'faq/README.md'
      - 'usage/*/**.md'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: changes
      run: |
        # æ£€æŸ¥å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹
        if git diff --name-only HEAD~1 HEAD | grep -q "changelog/README.md"; then
          echo "changelog_changed=true" >> $GITHUB_OUTPUT
        fi
        if git diff --name-only HEAD~1 HEAD | grep -q "faq/README.md"; then
          echo "faq_changed=true" >> $GITHUB_OUTPUT
        fi
        if git diff --name-only HEAD~1 HEAD | grep -q "usage/.*\.md"; then
          echo "usage_changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      if: steps.changes.outputs.changelog_changed == 'true'
      run: |
        node .github/scripts/update-version-info.js
    
    - name: æ£€æŸ¥æ–°é¡¹ç›®æ–‡ä»¶
      if: steps.changes.outputs.usage_changed == 'true'
      run: |
        node .github/scripts/check-new-projects.js
    
    - name: æ›´æ–°FAQç»Ÿè®¡
      if: steps.changes.outputs.faq_changed == 'true'
      run: |
        node .github/scripts/update-faq-stats.js
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "docs: ğŸ¤– è‡ªåŠ¨æ›´æ–°æ–‡æ¡£å†…å®¹
          
          - è‡ªåŠ¨åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯
          - æ›´æ–°å¯¼èˆªé“¾æ¥
          - ç»Ÿè®¡æ›´æ–°
          
          ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"
          git push
          echo "CHANGES_MADE=true" >> $GITHUB_ENV
        else
          echo "CHANGES_MADE=false" >> $GITHUB_ENV
        fi
    
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: env.CHANGES_MADE == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          
          // åˆ›å»ºæˆåŠŸé€šçŸ¥çš„ issue è¯„è®ºæˆ–æ–° issue
          const body = `## ğŸ¤– æ–‡æ¡£è‡ªåŠ¨æ›´æ–°å®Œæˆ
          
          **è§¦å‘åˆ†æ”¯**: ${context.ref}
          **æäº¤å“ˆå¸Œ**: ${context.sha.substring(0, 7)}
          **æ›´æ–°æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
          
          ### æ‰§è¡Œçš„æ“ä½œ
          - âœ… æ£€æŸ¥æ–‡æ¡£å˜æ›´
          - âœ… æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
          - âœ… åŒæ­¥å¯¼èˆªé“¾æ¥
          - âœ… æäº¤æ›´æ”¹åˆ°ä¸»åˆ†æ”¯
          
          ### æŸ¥çœ‹æ›´æ”¹
          - [æŸ¥çœ‹æœ€æ–°æäº¤](${context.payload.head_commit?.url || 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/commits'})
          - [æŸ¥çœ‹æ–‡æ¡£ç½‘ç«™](https://farmmaster.xyz)
          
          ---
          *æ­¤æ¶ˆæ¯ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;
          
          // å‘é€åˆ°ä»“åº“çš„ Issues
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“ æ–‡æ¡£è‡ªåŠ¨æ›´æ–°æŠ¥å‘Š - ${new Date().toLocaleDateString('zh-CN')}`,
            body: body,
            labels: ['documentation', 'automated']
          });
    
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          
          const body = `## âŒ æ–‡æ¡£è‡ªåŠ¨æ›´æ–°å¤±è´¥
          
          **è§¦å‘åˆ†æ”¯**: ${context.ref}
          **æäº¤å“ˆå¸Œ**: ${context.sha.substring(0, 7)}
          **å¤±è´¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
          
          ### é”™è¯¯ä¿¡æ¯
          è¯·æ£€æŸ¥ [Actions æ—¥å¿—](${context.payload.head_commit?.url || 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions'}) äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
          
          ### å¯èƒ½çš„åŸå› 
          - æ–‡æ¡£æ ¼å¼ä¸ç¬¦åˆè§£æè¦æ±‚
          - æƒé™ä¸è¶³
          - ç½‘ç»œè¿æ¥é—®é¢˜
          
          ### è§£å†³æ–¹æ¡ˆ
          1. æ£€æŸ¥æœ€æ–°çš„ changelog æ ¼å¼æ˜¯å¦æ­£ç¡®
          2. æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµè¿›è¡Œé‡è¯•
          3. è”ç³»æŠ€æœ¯è´Ÿè´£äººå¤„ç†
          
          ---
          *æ­¤æ¶ˆæ¯ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ æ–‡æ¡£è‡ªåŠ¨æ›´æ–°å¤±è´¥ - ${new Date().toLocaleDateString('zh-CN')}`,
            body: body,
            labels: ['documentation', 'automated', 'bug']
          });