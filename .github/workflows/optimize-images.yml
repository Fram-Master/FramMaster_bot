name: å›¾ç‰‡ä¼˜åŒ–

on:
  push:
    paths:
      - 'docs/assets/images/**'
  pull_request:
    paths:
      - 'docs/assets/images/**'

jobs:
  optimize-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…å›¾ç‰‡ä¼˜åŒ–å·¥å…·
      run: |
        npm install -g imagemin-cli imagemin-pngquant imagemin-mozjpeg imagemin-gifsicle imagemin-svgo
        
    - name: ä¼˜åŒ– PNG å›¾ç‰‡
      run: |
        if [ -d "docs/assets/images" ]; then
          find docs/assets/images -name "*.png" -type f | while read file; do
            echo "ä¼˜åŒ–: $file"
            imagemin "$file" --plugin=pngquant --out-dir="$(dirname "$file")"
          done
        fi
        
    - name: ä¼˜åŒ– JPG å›¾ç‰‡
      run: |
        if [ -d "docs/assets/images" ]; then
          find docs/assets/images -name "*.jpg" -o -name "*.jpeg" -type f | while read file; do
            echo "ä¼˜åŒ–: $file"
            imagemin "$file" --plugin=mozjpeg --out-dir="$(dirname "$file")"
          done
        fi
        
    - name: ä¼˜åŒ– SVG å›¾ç‰‡
      run: |
        if [ -d "docs/assets/images" ]; then
          find docs/assets/images -name "*.svg" -type f | while read file; do
            echo "ä¼˜åŒ–: $file"
            imagemin "$file" --plugin=svgo --out-dir="$(dirname "$file")"
          done
        fi
        
    - name: æ£€æŸ¥æ–‡ä»¶å¤§å°
      run: |
        echo "=== å›¾ç‰‡æ–‡ä»¶å¤§å°æ£€æŸ¥ ==="
        if [ -d "docs/assets/images" ]; then
          find docs/assets/images -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" \) -exec ls -lh {} \; | while read line; do
            size=$(echo $line | awk '{print $5}')
            file=$(echo $line | awk '{print $9}')
            echo "$file: $size"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿‡å¤§
            if [[ $file == *.png ]] && [[ $(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null) -gt 500000 ]]; then
              echo "âš ï¸  è­¦å‘Š: $file å¤§äº 500KBï¼Œå»ºè®®è¿›ä¸€æ­¥å‹ç¼©"
            elif [[ ($file == *.jpg || $file == *.jpeg) ]] && [[ $(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null) -gt 300000 ]]; then
              echo "âš ï¸  è­¦å‘Š: $file å¤§äº 300KBï¼Œå»ºè®®è¿›ä¸€æ­¥å‹ç¼©"
            fi
          done
        fi
        
    - name: æäº¤ä¼˜åŒ–åçš„å›¾ç‰‡
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "æ²¡æœ‰å›¾ç‰‡éœ€è¦ä¼˜åŒ–"
        else
          git add docs/assets/images/
          git commit -m "ğŸ–¼ï¸ è‡ªåŠ¨ä¼˜åŒ–å›¾ç‰‡æ–‡ä»¶å¤§å°
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push
        fi